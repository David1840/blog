<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="本网站主要供个人学习记录使用，如有侵权请立即邮件联系"><meta name="keywords" content="Android, Java, Linux, 数据结构"><title>Binder机制简析(二) | Programmer Liu</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Binder机制简析(二)</h1><a id="logo" href="/.">Programmer Liu</a><p class="description">一只有崇高理想的的程序猿</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Binder机制简析(二)</h1><div class="post-meta"><a href="/2018/08/03/Binder机制简析-二/#comments" class="comment-count"></a><p><span class="date">Aug 03, 2018</span><span><a href="/categories/Android系统/" class="category">Android系统</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>在<a href="https://david1840.github.io/2018/08/02/Binder%E6%9C%BA%E5%88%B6%E7%AE%80%E6%9E%90-%E4%B8%80/" target="_blank" rel="noopener">Binder机制简析(一)</a>中大概分析了Binder驱动，本章主要分析Service Manager。</p>
<h1 id="Service-Manager"><a href="#Service-Manager" class="headerlink" title="Service Manager"></a>Service Manager</h1><p>它扮演着Binder进程间通信机制上下文管理者的角色，同时负责管理系统中的Service组件，并且向Client组件提供获取Service代理对象的服务(主要工作：查询和注册服务)</p>
<h2 id="Service-Manager启动"><a href="#Service-Manager启动" class="headerlink" title="Service Manager启动"></a>Service Manager启动</h2><p>主要有下面几个步骤：</p>
<ol>
<li><code>binder_open</code> 打开驱动，将其映射到本进程的地址空间。</li>
<li><code>binder_become_context_manager</code> 注册为binder服务的大管家</li>
<li><code>binder_loop</code> 进入无限循环，处理从Client进程(Service和Client组件对Service Manager来说都是Client进程)通信请求。（循环调用<code>binder_thread_read</code>来检查Service Manager进程是否有新的进程间通信请求需要处理，如果有就交给<code>binder_parse</code>方法处理，在<code>binder_parse</code>中调用<code>svcmgr_handler</code>来解析信息，调用对应的方法，查询服务、注册服务、列举所有服务）</li>
</ol>
<p>流程图：</p>
<p><img src="/2018/08/03/Binder机制简析-二/create_servicemanager.jpg" alt=""></p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_state</span> *<span class="title">bs</span>;</span></span><br><span class="line">    <span class="comment">//打开binder驱动，申请128k字节大小的内存空间 【见小节2.2】</span></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成为上下文管理者</span></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    selinux_enabled = is_selinux_enabled(); <span class="comment">//selinux权限是否使能</span></span><br><span class="line">    sehandle = selinux_android_service_context_handle();</span><br><span class="line">    selinux_status_open(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selinux_enabled &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sehandle == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">            <span class="built_in">abort</span>(); <span class="comment">//无法获取sehandle</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getcon(&amp;service_manager_context) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">abort</span>(); <span class="comment">//无法获取service_manager上下文</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入无限循环，处理client端发来的请求</span></span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="binder-loop"><a href="#binder-loop" class="headerlink" title="binder_loop"></a>binder_loop</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">void</span> <span class="keyword">binder_loop(struct </span><span class="keyword">binder_state </span>*<span class="keyword">bs, </span><span class="keyword">binder_handler </span>func) &#123;</span><br><span class="line">    int res<span class="comment">;</span></span><br><span class="line">    <span class="keyword">struct </span><span class="keyword">binder_write_read </span><span class="keyword">bwr;</span></span><br><span class="line"><span class="keyword"> </span>   uint32_t readbuf[<span class="number">32</span>]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bwr.write_size </span>= <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    <span class="keyword">bwr.write_consumed </span>= <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    <span class="keyword">bwr.write_buffer </span>= <span class="number">0</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    readbuf[<span class="number">0</span>] = <span class="keyword">BC_ENTER_LOOPER;</span></span><br><span class="line"><span class="keyword"> </span>   //将<span class="keyword">BC_ENTER_LOOPER命令发送给binder驱动，让Service </span>Manager进入循环</span><br><span class="line">    <span class="keyword">binder_write(bs, </span>readbuf, sizeof(uint32_t))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    for (<span class="comment">;;) &#123;</span></span><br><span class="line">        <span class="keyword">bwr.read_size </span>= sizeof(readbuf)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bwr.read_consumed </span>= <span class="number">0</span><span class="comment">;</span></span><br><span class="line">        <span class="keyword">bwr.read_buffer </span>= (uintptr_t) readbuf<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        res = ioctl(<span class="keyword">bs-&gt;fd, </span><span class="keyword">BINDER_WRITE_READ, </span>&amp;<span class="keyword">bwr); </span>//进入循环，不断地<span class="keyword">binder读写过程</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line"></span><br><span class="line">        // 解析<span class="keyword">binder信息 </span></span><br><span class="line">        res = <span class="keyword">binder_parse(bs, </span><span class="number">0</span>, (uintptr_t) readbuf, <span class="keyword">bwr.read_consumed, </span>func)<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        <span class="meta">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="binder-parse"><a href="#binder-parse" class="headerlink" title="binder_parse"></a>binder_parse</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">int</span> <span class="keyword">binder_parse(struct </span><span class="keyword">binder_state </span>*<span class="keyword">bs, </span><span class="keyword">struct </span><span class="keyword">binder_io </span>*<span class="keyword">bio,</span></span><br><span class="line"><span class="keyword"> </span>                uintptr_t ptr, size_t size, <span class="keyword">binder_handler </span>func)</span><br><span class="line">&#123;</span><br><span class="line">    int r = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    uintptr_t <span class="meta">end</span> = ptr + (uintptr_t) size<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">while</span> (ptr &lt; <span class="meta">end</span>) &#123;</span><br><span class="line">        uint32_t cmd = *(uint32_t *) ptr<span class="comment">;</span></span><br><span class="line">        ptr += sizeof(uint32_t)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">switch(cmd) </span>&#123;</span><br><span class="line">        case <span class="keyword">BR_NOOP: </span> //无操作，退出循环</span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_TRANSACTION_COMPLETE:</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_INCREFS:</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_ACQUIRE:</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_RELEASE:</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_DECREFS:</span></span><br><span class="line"><span class="keyword"> </span>           ptr += sizeof(<span class="keyword">struct </span><span class="keyword">binder_ptr_cookie);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_TRANSACTION: </span>&#123;</span><br><span class="line">            <span class="keyword">struct </span><span class="keyword">binder_transaction_data </span>*txn = (<span class="keyword">struct </span><span class="keyword">binder_transaction_data </span>*) ptr<span class="comment">;</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">binder_dump_txn(txn);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="meta">if</span> (func) &#123;</span><br><span class="line">                unsigned rdata[<span class="number">256</span>/<span class="number">4</span>]<span class="comment">;</span></span><br><span class="line">                <span class="keyword">struct </span><span class="keyword">binder_io </span>msg<span class="comment">; </span></span><br><span class="line">                <span class="keyword">struct </span><span class="keyword">binder_io </span>reply<span class="comment">;</span></span><br><span class="line">                int res<span class="comment">;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">bio_init(&amp;reply, </span>rdata, sizeof(rdata), <span class="number">4</span>)<span class="comment">;</span></span><br><span class="line">                <span class="keyword">bio_init_from_txn(&amp;msg, </span>txn)<span class="comment">; //从txn解析出binder_io信息</span></span><br><span class="line">                //func在这里就指向<span class="keyword">svcmgr_handler</span></span><br><span class="line"><span class="keyword"> </span>               res = func(<span class="keyword">bs, </span>txn, &amp;msg, &amp;reply)<span class="comment">;</span></span><br><span class="line">                <span class="keyword">binder_send_reply(bs, </span>&amp;reply, txn-&gt;<span class="meta">data</span>.ptr.<span class="keyword">buffer, </span>res)<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">            ptr += sizeof(*txn)<span class="comment">;</span></span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        case <span class="keyword">BR_REPLY: </span>&#123;</span><br><span class="line">            <span class="keyword">struct </span><span class="keyword">binder_transaction_data </span>*txn = (<span class="keyword">struct </span><span class="keyword">binder_transaction_data </span>*) ptr<span class="comment">;</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">binder_dump_txn(txn);</span></span><br><span class="line"><span class="keyword"> </span>           <span class="meta">if</span> (<span class="keyword">bio) </span>&#123;</span><br><span class="line">                <span class="keyword">bio_init_from_txn(bio, </span>txn)<span class="comment">;</span></span><br><span class="line">                <span class="keyword">bio </span>= <span class="number">0</span><span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">            ptr += sizeof(*txn)<span class="comment">;</span></span><br><span class="line">            r = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        case <span class="keyword">BR_DEAD_BINDER: </span>&#123;</span><br><span class="line">            <span class="keyword">struct </span><span class="keyword">binder_death </span>*death = (<span class="keyword">struct </span><span class="keyword">binder_death </span>*)(uintptr_t) *(<span class="keyword">binder_uintptr_t </span>*)ptr<span class="comment">;</span></span><br><span class="line">            ptr += sizeof(<span class="keyword">binder_uintptr_t);</span></span><br><span class="line"><span class="keyword"> </span>           // <span class="keyword">binder死亡消息</span></span><br><span class="line"><span class="keyword"> </span>           death-&gt;func(<span class="keyword">bs, </span>death-&gt;ptr)<span class="comment">;</span></span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       &#125;</span><br><span class="line">        case <span class="keyword">BR_FAILED_REPLY:</span></span><br><span class="line"><span class="keyword"> </span>           r = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       case <span class="keyword">BR_DEAD_REPLY:</span></span><br><span class="line"><span class="keyword"> </span>           r = -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">            <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>       default:</span><br><span class="line">            return -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return r<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="svcmgr-handler"><a href="#svcmgr-handler" class="headerlink" title="svcmgr_handler"></a>svcmgr_handler</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">int</span> <span class="keyword">svcmgr_handler(struct </span><span class="keyword">binder_state </span>*<span class="keyword">bs,</span></span><br><span class="line"><span class="keyword"> </span>                  <span class="keyword">struct </span><span class="keyword">binder_transaction_data </span>*txn,</span><br><span class="line">                   <span class="keyword">struct </span><span class="keyword">binder_io </span>*msg,</span><br><span class="line">                   <span class="keyword">struct </span><span class="keyword">binder_io </span>*reply)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct </span><span class="keyword">svcinfo </span>*si<span class="comment">; </span></span><br><span class="line">    uint16_t *s<span class="comment">;</span></span><br><span class="line">    size_t len<span class="comment">;</span></span><br><span class="line">    uint32_t handle<span class="comment">;</span></span><br><span class="line">    uint32_t <span class="keyword">strict_policy;</span></span><br><span class="line"><span class="keyword"> </span>   int allow_isolated<span class="comment">;</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">strict_policy </span>= <span class="keyword">bio_get_uint32(msg);</span></span><br><span class="line"><span class="keyword"> </span>   s = <span class="keyword">bio_get_string16(msg, </span>&amp;len)<span class="comment">;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch(txn-&gt;code) </span>&#123;</span><br><span class="line">    case <span class="keyword">SVC_MGR_GET_SERVICE:</span></span><br><span class="line"><span class="keyword"> </span>   case <span class="keyword">SVC_MGR_CHECK_SERVICE: </span></span><br><span class="line">        s = <span class="keyword">bio_get_string16(msg, </span>&amp;len)<span class="comment">; //服务名</span></span><br><span class="line">        //根据名称查找相应服务</span><br><span class="line">        handle = do_find_service(<span class="keyword">bs, </span>s, len, txn-&gt;sender_euid, txn-&gt;sender_pid)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">bio_put_ref(reply, </span>handle)<span class="comment">;</span></span><br><span class="line">        return <span class="number">0</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    case <span class="keyword">SVC_MGR_ADD_SERVICE: </span></span><br><span class="line">        s = <span class="keyword">bio_get_string16(msg, </span>&amp;len)<span class="comment">; //服务名</span></span><br><span class="line">        handle = <span class="keyword">bio_get_ref(msg); </span>//handle</span><br><span class="line">        allow_isolated = <span class="keyword">bio_get_uint32(msg) </span>? <span class="number">1</span> : <span class="number">0</span><span class="comment">;</span></span><br><span class="line">         //注册指定服务</span><br><span class="line">        <span class="meta">if</span> (do_add_service(<span class="keyword">bs, </span>s, len, handle, txn-&gt;sender_euid,</span><br><span class="line">            allow_isolated, txn-&gt;sender_pid))</span><br><span class="line">            return -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">        <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   case <span class="keyword">SVC_MGR_LIST_SERVICES: </span>&#123;  </span><br><span class="line">        uint32_t n = <span class="keyword">bio_get_uint32(msg);</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">if</span> (!<span class="keyword">svc_can_list(txn-&gt;sender_pid)) </span>&#123;</span><br><span class="line">            return -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        si = <span class="keyword">svclist;</span></span><br><span class="line"><span class="keyword"> </span>       <span class="meta">while</span> ((n-- &gt; <span class="number">0</span>) &amp;&amp; si)</span><br><span class="line">            si = si-&gt;next<span class="comment">;</span></span><br><span class="line">        <span class="meta">if</span> (si) &#123;</span><br><span class="line">            <span class="keyword">bio_put_string16(reply, </span>si-&gt;name)<span class="comment">;</span></span><br><span class="line">            return <span class="number">0</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        return -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="symbol">    default:</span></span><br><span class="line">        return -<span class="number">1</span><span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bio_put_uint32(reply, </span><span class="number">0</span>)<span class="comment">;</span></span><br><span class="line">    return <span class="number">0</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法的功能：查询服务，注册服务，以及列举所有服务</p>
<h2 id="核心工作"><a href="#核心工作" class="headerlink" title="核心工作"></a>核心工作</h2><p>servicemanager的核心工作就是注册服务和查询服务:</p>
<h3 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h3><p>记录服务名和handle信息，保存到svclist列表<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_add_service</span><span class="params">(struct binder_state *bs,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">uint32_t</span> handle, <span class="keyword">uid_t</span> uid, <span class="keyword">int</span> allow_isolated,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">pid_t</span> spid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!handle || (len == <span class="number">0</span>) || (len &gt; <span class="number">127</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//权限检查</span></span><br><span class="line">    <span class="keyword">if</span> (!svc_can_register(s, len, spid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务检索</span></span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    <span class="keyword">if</span> (si) &#123;</span><br><span class="line">        <span class="keyword">if</span> (si-&gt;handle) &#123;</span><br><span class="line">            svcinfo_death(bs, si); <span class="comment">//服务已注册时，释放相应的服务</span></span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        si = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*si) + (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">        <span class="keyword">if</span> (!si) &#123;  <span class="comment">//内存不足，无法分配足够内存</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        <span class="built_in">memcpy</span>(si-&gt;name, s, (len + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>)); <span class="comment">//内存拷贝服务信息</span></span><br><span class="line">        si-&gt;name[len] = <span class="string">'\0'</span>;</span><br><span class="line">        si-&gt;death.func = (<span class="keyword">void</span>*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;allow_isolated = allow_isolated;</span><br><span class="line">        si-&gt;next = svclist; <span class="comment">// svclist保存所有已注册的服务</span></span><br><span class="line">        svclist = si;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以BC_ACQUIRE命令，handle为目标的信息，通过ioctl发送给binder驱动</span></span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    <span class="comment">//以BC_REQUEST_DEATH_NOTIFICATION命令的信息，通过ioctl发送给binder驱动，主要用于清理内存等收尾工作。</span></span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册服务的分以下3部分工作：</p>
<ul>
<li><code>svc_can_register</code>：检查权限，检查selinux权限是否满足；</li>
<li><code>find_svc</code>：服务检索，根据服务名来查询匹配的服务；</li>
<li><code>svcinfo_death</code>：释放服务，当查询到已存在同名的服务，则先清理该服务信息，再将当前的服务加入到服务列表svclist；</li>
</ul>
<h3 id="查询服务"><a href="#查询服务" class="headerlink" title="查询服务"></a>查询服务</h3><p>根据服务名查询相应的的handle信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> do_find_service(struct binder_state *bs, <span class="keyword">const</span> <span class="keyword">uint16_t</span> *s, <span class="keyword">size_t</span> len, <span class="keyword">uid_t</span> uid, <span class="keyword">pid_t</span> spid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//查询相应的服务 </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">svcinfo</span> *<span class="title">si</span> = <span class="title">find_svc</span>(<span class="title">s</span>, <span class="title">len</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!si || !si-&gt;handle) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!si-&gt;allow_isolated) &#123;</span><br><span class="line">        <span class="keyword">uid_t</span> appid = uid % AID_USER;</span><br><span class="line">        <span class="comment">//检查该服务是否允许孤立于进程而单独存在</span></span><br><span class="line">        <span class="keyword">if</span> (appid &gt;= AID_ISOLATED_START &amp;&amp; appid &lt;= AID_ISOLATED_END) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务是否满足查询条件</span></span><br><span class="line">    <span class="keyword">if</span> (!svc_can_find(s, len, spid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> si-&gt;handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询到目标服务，并返回该服务所对应的handle</p>
<h2 id="获取Service-Manager代理"><a href="#获取Service-Manager代理" class="headerlink" title="获取Service Manager代理"></a>获取Service Manager代理</h2><p>由于Service Manager本身也是一个Service组件，因此，其他Service组件和Client组件在使用它提供的组件之前，也要获取它的代理对象。Service Manager代理对象的类型为BpServiceManager，它用来描述一个实现了IServiceManager接口的Client组件。</p>
<p>IServiceManager接口定义了getService()、chaekService()、addService()、listService()方法。</p>
<p>Android系统在应用程序框架层的Binder库中提供了一个函数<code>defaultServiceManager()</code>，该方法为单例模式，保证一个进程中最多只有一个Service Manager代理对象。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager&gt; defaultServiceManager()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (gDefaultServiceManager != <span class="keyword">NULL</span>) <span class="keyword">return</span> gDefaultServiceManager;</span><br><span class="line">    &#123;</span><br><span class="line">        AutoMutex _l(gDefaultServiceManagerLock); <span class="comment">//加锁</span></span><br><span class="line">        <span class="keyword">while</span> (gDefaultServiceManager == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">             <span class="comment">//关键代码</span></span><br><span class="line">            gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(ProcessState::self()-&gt;getContextObject(<span class="keyword">NULL</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (gDefaultServiceManager == <span class="keyword">NULL</span>)</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> gDefaultServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当尝试创建或获取ServiceManager时，ServiceManager可能尚未准备就绪，这时通过sleep 1秒后，循环尝试获取直到成功。</p>
<p>gDefaultServiceManager的创建过程,可分解为以下3个步骤：</p>
<ol>
<li><code>ProcessState::self()</code>：用于获取ProcessState对象(也是单例模式)，每个进程有且只有一个ProcessState对象，存在则直接返回，不存在则创建。</li>
</ol>
<blockquote>
<pre><code>ProcessState::self()主要工作：
    调用open()，打开/dev/binder驱动设备；
    再利用mmap()，创建大小为1M-8K的内存地址空间；
    设定当前进程最大的最大并发Binder线程个数为16。
</code></pre></blockquote>
<ol start="2">
<li><code>getContextObject()</code>： 用于获取BpBinder对象，对于handle=0的BpBinder对象，存在则直接返回，不存在才创建。</li>
<li><code>interface_cast&lt;IServiceManager&gt;()</code>：用于获取BpServiceManager对象。</li>
</ol>
<blockquote>
<pre><code>在整个Binder系统中handle=0代表ServiceManager所对应的BBinder
</code></pre></blockquote>
<p><code>defaultServiceManager</code> 等价于 <code>new BpServiceManager(new BpBinder(0))</code>;</p>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/系统/">系统</a><a href="/tags/binder/">binder</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/08/05/Binder机制简析-三/" class="pre">Binder机制简析(三)</a><a href="/2018/08/02/Binder机制简析-一/" class="next">Binder机制简析(一)</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODA5Ny8xNDYyNw=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Service-Manager"><span class="toc-text">Service Manager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Manager启动"><span class="toc-text">Service Manager启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-text">main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binder-loop"><span class="toc-text">binder_loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binder-parse"><span class="toc-text">binder_parse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#svcmgr-handler"><span class="toc-text">svcmgr_handler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心工作"><span class="toc-text">核心工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注册服务"><span class="toc-text">注册服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询服务"><span class="toc-text">查询服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取Service-Manager代理"><span class="toc-text">获取Service Manager代理</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/29/FFmpeg代码实现抽取音频、视频数据/">FFmpeg代码实现抽取音频、视频数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/FFmpeg常用结构体、方法简介/">FFmpeg常用结构体、方法简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/FFmpeg实现简单直播系统/">FFmpeg实现简单直播系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/22/FFmpeg常用命令/">FFmpeg常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/Mac下FFmpeg的下载-编译和安装/">FFmpeg的下载,编译和安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/19/音视频基础概念/">音视频基础概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/28/Netty学习-一/">easyIM Netty开发(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/24/Java内存分配及GC回收/">Java内存分配及GC回收</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/Android中的ClassLoader简析/">Android中的ClassLoader简析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/22/Java中的ClassLoader简析/">Java中的ClassLoader简析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android系统/">Android系统</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux系统/">Linux系统</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音视频/">音视频</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/FFmpeg/" style="font-size: 15px;">FFmpeg</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/ClassLoader/" style="font-size: 15px;">ClassLoader</a> <a href="/tags/BroadCast/" style="font-size: 15px;">BroadCast</a> <a href="/tags/原理/" style="font-size: 15px;">原理</a> <a href="/tags/binder/" style="font-size: 15px;">binder</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/指针/" style="font-size: 15px;">指针</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/音视频/" style="font-size: 15px;">音视频</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/系统调用/" style="font-size: 15px;">系统调用</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/LRU/" style="font-size: 15px;">LRU</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Reactor/" style="font-size: 15px;">Reactor</a> <a href="/tags/高性能/" style="font-size: 15px;">高性能</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/编译时注解/" style="font-size: 15px;">编译时注解</a> <a href="/tags/KAPT/" style="font-size: 15px;">KAPT</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a><ul></ul><a href="https://richardwrq.github.io/" title="Richard Wu" target="_blank">Richard Wu</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">刘伟.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>